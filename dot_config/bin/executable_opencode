#!/usr/bin/env bash
# Helper script to run local OpenCode development version
# Can be run from anywhere - preserves caller's CWD for OpenCode

set -e

# Save the caller's current working directory
CALLER_CWD="$(pwd)"

# Get the script's directory (repo root)
SCRIPT_DIR="$HOME/p/opencode"
OPENCODE_DIR="$SCRIPT_DIR/packages/opencode"

# Clone the repo if it doesn't exist
if [ ! -d "$SCRIPT_DIR" ]; then
	(cd "$HOME/p" && gclone opencode)
fi

# If no project path is specified and we're not in the opencode repo,
# use the caller's CWD as the first positional arg
if [ $# -eq 0 ] || [[ "$1" == -* ]]; then
	# No positional args or first arg is a flag, so prepend the caller's CWD
	set -- "$CALLER_CWD" "$@"
fi

# Run from the opencode package directory so Bun can find its config and dependencies
# Set PWD environment variable so OpenCode knows the original working directory
cd "$OPENCODE_DIR"
PWD="$CALLER_CWD" exec bun --conditions=browser ./src/index.ts "$@"
