#!/bin/bash

jira-done() {
	id="$1"
	jira issue move $id Start
	jira issue move $id --resolution Done "Skip Review"
}

# Create temp files for state and helper script
FILTER_STATE=$(mktemp)
HELPER_SCRIPT=$(mktemp)
echo "0" >"$FILTER_STATE"
trap 'rm -f "$FILTER_STATE" "$HELPER_SCRIPT"' EXIT

# Get jira user once
JIRA_ME=$(jira me)

# Create helper script for fzf to call
cat >"$HELPER_SCRIPT" <<'HELPER'
#!/bin/bash
FILTER_STATE="$1"
JIRA_ME="$2"
ACTION="$3"

jira_list() {
    local filter="$1"
    case "$filter" in
        0) jira issue list --plain --no-headers --columns type,key,status,summary --assignee "$JIRA_ME" -s~Done ;;
        1) jira issue list --plain --no-headers --columns type,key,status,summary --assignee "$JIRA_ME" -s Done ;;
        2) jira issue list --plain --no-headers --columns type,key,status,summary --assignee "$JIRA_ME" ;;
    esac
}

# cycle: update state and output the NEW filter name
if [ "$ACTION" = "cycle" ]; then
    state=$(cat "$FILTER_STATE")
    case "$state" in
        0) echo "1" > "$FILTER_STATE"; echo "Done" ;;
        1) echo "2" > "$FILTER_STATE"; echo "All" ;;
        2) echo "0" > "$FILTER_STATE"; echo "Not Done" ;;
    esac
# list: read current state and fetch issues
elif [ "$ACTION" = "list" ]; then
    state=$(cat "$FILTER_STATE")
    jira_list "$state"
# header: read current state and output header
elif [ "$ACTION" = "header" ]; then
    state=$(cat "$FILTER_STATE")
    case "$state" in
        0) echo "enter: open | ctrl-o: branch | ctrl-d: mark done | ctrl-s: filter [Not Done]" ;;
        1) echo "enter: open | ctrl-o: branch | ctrl-d: mark done | ctrl-s: filter [Done]" ;;
        2) echo "enter: open | ctrl-o: branch | ctrl-d: mark done | ctrl-s: filter [All]" ;;
    esac
fi
HELPER
chmod +x "$HELPER_SCRIPT"

selected=$(
	"$HELPER_SCRIPT" "$FILTER_STATE" "$JIRA_ME" list |
		fzf --layout reverse \
			--header "enter: open | ctrl-o: branch | ctrl-d: mark done | ctrl-s: filter [Not Done]" \
			--expect=ctrl-o \
			--expect=ctrl-d \
			--bind "ctrl-s:execute-silent($HELPER_SCRIPT $FILTER_STATE $JIRA_ME cycle > /dev/null)+reload($HELPER_SCRIPT $FILTER_STATE $JIRA_ME list)+transform-header($HELPER_SCRIPT $FILTER_STATE $JIRA_ME header)" \
			--preview "jira issue view {2}" \
			--preview-window "bottom:60%:wrap"
)

# Check if fzf was cancelled (e.g., Esc key)
if [[ -z "$selected" ]]; then
	echo "No issue selected."
	exit 1
fi

# fzf with --expect outputs the key pressed on the first line,
# and the selected item(s) on subsequent lines.
keypress=$(echo "$selected" | head -n 1)
selection_line=$(echo "$selected" | tail -n +2)

# If Enter was pressed (or no key specified by --expect), proceed to open
if [[ -z "$selection_line" ]]; then
	echo "No selection line found."
	exit 1
fi
id=$(echo "$selection_line" | awk '{print $2}')
if [[ -z "$id" ]]; then
	echo "Could not extract issue ID from selection: $selection_line" >&2
	exit 1
fi

# Handle actions based on keypress
case "$keypress" in
ctrl-o)
	# Create a new branch based on the issue ID and summary
	git checkout -b "$id-$(jira issue view "$id" --raw |
		jq -r '.fields.summary' |
		tr '[:upper:]' '[:lower:]' |
		tr -s ' ' '-' |
		tr -dc '[:alnum:]-')"
	exit 0 # Exit after creating the branch
	;;
ctrl-d)
	# Mark the issue as done
	jira issue move "$id" Start
	jira issue move "$id" --resolution Done "Skip Review"
	# Continue to open the issue in the browser after marking as done
	;;
esac

echo "Opening issue: $id"
jira open "$id"
