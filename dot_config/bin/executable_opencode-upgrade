#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$HOME/p/opencode"

if [[ ! -d "$REPO_ROOT" ]]; then
	echo "Repository not found. Cloning opencode..."
	cd "$HOME/p"
	gclone opencode
fi

if [[ "${1:-}" == "--pull" ]] || [[ "${1:-}" == "-p" ]]; then
	echo "Pulling latest changes..."
	cd "$REPO_ROOT"
	git fetch upstream
	git rebase upstream/dev
fi

echo "Building opencode..."
cd "$REPO_ROOT/packages/opencode"
bun run build --single

echo "Installing to ~/.local/bin..."
mkdir -p ~/.local/bin
ln -sf $PWD/dist/opencode-darwin-arm64/bin/opencode ~/.local/bin/opencode

echo "Done! opencode installed to ~/.local/bin/opencode"
