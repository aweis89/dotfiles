#!/bin/bash

# Validate required environment variables
if [ -z "$GITHUB_TOKEN" ]; then
	echo "GITHUB_TOKEN not set" >&2
	exit 1
fi

input=$1

# Parse input to determine org and repo
if [[ "$input" == *"/"* ]]; then
	# Input is "owner/repo" format
	org="${input%%/*}"
	repo="${input#*/}"
else
	# Input is just repo name, use GITHUB_ORG
	if [ -z "$GITHUB_ORG" ]; then
		echo "GITHUB_ORG not set and no owner provided in format 'owner/repo'" >&2
		exit 1
	fi
	org="$GITHUB_ORG"
	repo="$input"
fi

# Inside an existing git repo: determine repo name and set/reset origin
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
	# If no arg provided, try to extract from remote URL, otherwise use directory name
	if [ -z "$input" ]; then
		# Try to get repo name from existing origin remote URL
		origin_url=$(git remote get-url origin 2>/dev/null)
		if [ -n "$origin_url" ]; then
			# Extract owner/repo from URL (handles both SSH and HTTPS formats)
			full_repo=$(echo "$origin_url" | sed -E 's|.*[:/]([^/]+/[^/]+)\.git$|\1|')
			org="${full_repo%%/*}"
			repo="${full_repo#*/}"
		fi
		# Fallback to current directory name if still empty
		if [ -z "$repo" ]; then
			if [ -z "$GITHUB_ORG" ]; then
				echo "GITHUB_ORG not set and cannot determine org from remote" >&2
				exit 1
			fi
			org="$GITHUB_ORG"
			repo=$(basename "$PWD")
		fi
	fi

	# Verify repo exists using gh cli
	if ! gh repo view "$org/$repo" >/dev/null 2>&1; then
		repo=$(gh repo list "$org" --limit 1000 --json name --jq '.[].name' | fzf)
		echo "Selected repo: $repo"
		if [ -z "$repo" ]; then
			echo "No repository selected" >&2
			exit 1
		fi
	fi

	url="https://$GITHUB_TOKEN@github.com/$org/$repo"
	if git remote | grep -q '^origin$'; then
		git remote set-url origin "$url"
	else
		git remote add origin "$url"
	fi
	exit 0
fi

# Not inside a git repo: if no arg provided, interactive selection via fzf
if [ -z "$repo" ]; then
	if [ -z "$GITHUB_ORG" ]; then
		echo "GITHUB_ORG not set and no owner provided" >&2
		exit 1
	fi
	org="$GITHUB_ORG"
	repo=$(gh repo list "$org" --limit 1000 --json name --jq '.[].name' | fzf)
	if [ -z "$repo" ]; then
		echo "No repository selected" >&2
		exit 1
	fi
fi

url="https://$GITHUB_TOKEN@github.com/$org/$repo"

# Clone and enter the repo
git clone "$url" || exit 1
cd "$repo" || exit 1
